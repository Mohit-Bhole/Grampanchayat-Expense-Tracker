{% extends 'base.html' %}
{% block content %}
<h1 class="page-title">Public Transparency Portal</h1>

<section class="card">
	<h2>Announcements</h2>
	<ul class="list">
		{% for a in announcements %}
			<li><strong>{{ a.title }}</strong> — {{ a.created_at.strftime('%Y-%m-%d') }}<br>{{ a.body }}</li>
		{% else %}
			<li>No announcements yet.</li>
		{% endfor %}
	</ul>
</section>

<section class="card">
	<h2>Spending Overview</h2>
	<form class="filters" method="get">
		<select name="category_id">
			<option value="">All categories</option>
			{% for c in categories %}
				<option value="{{ c.id }}" {% if selected_category_id == c.id %}selected{% endif %}>{{ c.name }}</option>
			{% endfor %}
		</select>
		<label>From <input type="date" name="start_date" value="{{ start_date }}"></label>
		<label>To <input type="date" name="end_date" value="{{ end_date }}"></label>
		<button class="btn btn-secondary" type="submit">Apply</button>
		<a class="btn btn-light" href="{{ url_for('api_export_csv', category_id=selected_category_id, start_date=start_date, end_date=end_date) }}">Export CSV</a>
	</form>
	<div class="chart-wrap">
		<canvas id="expensesChart" height="120"></canvas>
	</div>
	<p class="total">Total in view: <strong>₹{{ '%.2f'|format(total_spent) }}</strong></p>
</section>

<section class="card">
	<h2>Recent Expenses</h2>
	<table class="table">
		<thead>
			<tr>
				<th>Title</th>
				<th>Category</th>
				<th class="num">Amount (₹)</th>
				<th>Date</th>
				<th>Receipt</th>
			</tr>
		</thead>
		<tbody>
			{% for e in expenses %}
			<tr>
				<td>{{ e.title }}</td>
				<td>{{ e.category.name if e.category else '' }}</td>
				<td class="num">{{ '%.2f'|format(e.amount) }}</td>
				<td>{{ e.date_spent }}</td>
				<td>{% if e.receipt_url %}<a href="{{ e.receipt_url }}" target="_blank">View</a>{% else %}-{% endif %}</td>
			</tr>
			{% else %}
			<tr><td colspan="5">No expenses found.</td></tr>
			{% endfor %}
		</tbody>
	</table>
</section>

<script>
const params = new URLSearchParams(window.location.search);
fetch(`/api/expenses_summary?${params.toString()}`)
	.then(r => r.json())
	.then(data => renderExpensesChart(data.labels, data.totals));
</script>
{% endblock %}
